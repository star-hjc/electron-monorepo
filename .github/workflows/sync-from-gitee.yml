name: Sync from Gitee to GitHub

on:
  workflow_dispatch:

permissions:
  contents: write
  workflows: write

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      docs_changed: ${{ steps.check-docs.outputs.docs_changed }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    - run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    - run: git remote add gitee https://gitee.com/hejiachen/ai-chat-ultral-pc.git
    - run: git fetch gitee master --tags
    - name: Record current commit
      id: record-before
      run: echo "before=$(git rev-parse master)" >> $GITHUB_OUTPUT

    - name: Fast-forward from Gitee
      run: |
        git checkout master
        if git rev-parse --verify gitee/master >/dev/null 2>&1; then
          if ! git diff --quiet master gitee/master; then
            git merge --ff-only gitee/master
          fi
        fi
    - name: Check docs changed
      id: check-docs
      run: |
        after=$(git rev-parse master)
        if git diff --name-only "${{ steps.record-before.outputs.before }}" "$after" | grep -q '^docs/'; then
          echo "docs_changed=true" >> $GITHUB_OUTPUT
          echo "Docs changed between ${{ steps.record-before.outputs.before }} and $after"
        else
          echo "docs_changed=false" >> $GITHUB_OUTPUT
          echo "Docs not changed"
        fi

    - name: Push to GitHub
      run: |
        git push origin master
        git push --tags origin

  publish-docs:
    needs: sync
    if: needs.sync.outputs.docs_changed == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    - uses: actions/setup-node@v4
      with:
        node-version: '20.19.5'
    - uses: pnpm/action-setup@v2
      with:
        version: 10.8.1
    - run: pnpm install --no-frozen-lockfile
    - run: pnpm docs:build
    - name: Upload docs via SSH
      env:
        HOST: ${{ secrets.DOCS_SSH_HOST }}
        USERNAME: ${{ secrets.DOCS_SSH_USERNAME }}
        PASSWORD: ${{ secrets.DOCS_SSH_PASSWORD }}
        TARGET: ${{ secrets.DOCS_TARGET_PATH }}
      run: |
        sudo apt-get update && sudo apt-get install -y sshpass
        sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no -r docs/.vitepress/dist/* "$USERNAME@$HOST:$TARGET/"
